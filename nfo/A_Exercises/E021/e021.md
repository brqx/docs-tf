<!-- Proyecto : # docs-tf -->
# Ejercicio E016 - Recordando Terraform - Realidad practica
# Ejercicio 016 : Puesta en marcha de autoscaling EC2 accesible desde Route 53 con ALB WWW
# Latest Testing Apply : XX - XX - 2023

<!-- Nivel 2 E016 -  V0.0.1 - 2023 Mar -->

## Secciones

### A. Información previa para poder entender el proceso

Vamos a montar y entender autoscaling tanto com launch configuration como con launch template

De entrada vamos a comprobar autoscaling por tiempo ( a una hora se produce el escalado ) y por cpu

Para poder ejecutar ASG por CPU usaremos la utilidad stress

El tiempo lo obtenemos con la funcion timestamp : 

```
time = "2023-03-08T13:38:08Z"
```

Veamos las opciones de la orden stress :

--cpu – Denotes the number of cores on which load will be generated.
-v – Enables verbose mode.
--timeout – Specifies the time for which load should be generated.

He probado stress, que requiere instalarla en la instancia y entrar posteriormente en la instancia para lanzarlo, lo cual no es muy agil.

Vamos a usar en su lugar un curl con xargs de forma que atacamos al dominio en lugar de una instancia

seq 1 10000 | xargs -P100 -I{} curl https://DOMINIO

Son 10000 peticiones en paralelo 100 

Finalmente lanzamos esta orden en un servidor : 

time seq 1 300000 | xargs -P100 -I{} curl https://DOMINIO

Tarda unos 7 minutos y nos permite extresar las instancias

No lo tengo del todo controlado pues no para de crear instancias

### B. Aspectos relacionados con ASG

Se prueba exitosamente autoscaling con tiempo

```
aw2l
i-07cf197f36fa9d811:ami-03e9b8a6364841587:t3.micro:None:None:eu-west-1a:None:terminated
i-05f435c408c57ebf5:ami-03e9b8a6364841587:t3.micro:10.20.1.123:52.210.197.239:eu-west-1a:None:running
i-07613d977442c6edb:ami-03e9b8a6364841587:t3.micro:10.20.1.61:54.195.133.73:eu-west-1a:None:running
i-0f067604327b34d37:ami-03e9b8a6364841587:t3.micro:10.20.2.225:63.33.41.229:eu-west-1b:None:running
i-033669717427b9030:ami-03e9b8a6364841587:t3.micro:None:None:eu-west-1b:None:terminated
i-018e2bbb21e18b671:ami-03e9b8a6364841587:t3.micro:10.20.2.179:34.243.243.138:eu-west-1b:None:running
````

Para el ASG basado en tiempo no necesitamos una politica de escalado solo la funcion de ajuste : 

Indicamos el minimo, maximo y el deseado y lo enlazamos con el grupo ASG

``
resource "aws_autoscaling_schedule" "mygroup_schedule" {
  scheduled_action_name  = "autoscalegroup_action"
  min_size               = 1
  max_size               = 5
  desired_capacity       = 4

# defining the start_time of autoscaling if you think traffic can peak at this time.
# En irlanda es una hora menos
  start_time             = "2023-03-08T13:45:00Z"

  autoscaling_group_name = aws_autoscaling_group.main.name
}

```

Viendo la siguiente nota : 

"Es posible que desee omitir el atributo desired_capacity del grupo aws_autoscaling_group adjunto cuando utilice políticas de autoescalado"

Parece que debemos desactivar ese parametro "desired_capacity"

En cambio para el ajusto por CPU si vamos a necesitar esa política





### C. Aspectos relacionados con Terraform

Vemos que tarda cuatro minutos en crear y unos dos minutos en destruir. hay que esperar un poquito para que se establezcan las variantes en la validación SSL.

Veamos como responde a todas las variantes : 

```
curl http://www.DOMINIO
Hi Friend of brqx , I am ip-10-20-2-35.eu-west-1.compute.internal hosted by Terraform </BR>
For ALB ONE Desktop --> My IP is : 10.20.2.35 

```

Sin duda tenemos la configuración correcta para subdominios. Ahora retrocedemos y lo preparamos para Cloudfront

### D. Enlaces de infraestructura
 
@providers.tf  (Definido en E000)             @backend.tf     (Definido en E000)   \         
@vpc.tf        (Definido en E000)             @public_subnets.tf (Definido en E001)   

### E. Enlaces de informacion 

@variables.tf  (Definido en E010)             @maps_zones.tf          (Definido en E011 )

### F. Enlaces de EC2

@ami.tf        (Definido en E001)            @ec2_sg.tf         (Definido en E003)             

### G. Enlaces de Ejercicio

@acm.tf                 (Definido en E010 )

@alb_ls.tf               (Definido en E015 )  \
@alb_ls_ssl.tf           (Definido en E015 )  \
@alb_sg.tf               (Definido en E011 )  \
@alb_tg.tf               (Definido en E015 )  \
@alb.tf                  (Definido en E015 )  \
@alb_sg.tf               (Definido en E011 )  \

@main.tf                 (Definido en E006 )  \
@s3_iam_role.tf          (Definido en E005 )  \
@route53_alb.tf          (Definido en E011 )  \
@public_subnets_b.tf     (Definido en E011 )  


@s3_variables            (Definido en E015 )  \
@s3_for_alb_existent.tf  (Definido en E015 )  

@ec2_tf.tf               (Definido en E015 )  \
@ec2_r53.tf              (Definido en E015 )


### I. Ficheros Nuevos

alb.tf    -->  Redireccion http a https y de Movil a Imagen        \
acm_alb.tf                 -->  Gestion de certificados con subdominios             \
providers.tf              -->  Incluimos US-East-1 como nueva zona pra cloudfront   \

### J. Comandos

ti --> Terraform Init                  \
tv --> Terraform Validate              \
tp --> Terraform Plan                  \
tta --> Terraform Apply                \
ttd --> Time Terraform Destroy         

### K. Grafico

Vamos a ver lo que hemos definido. 

Como se puede ver, require algo de código adiccional.

```
[DOMAIN dname  ]
[[A_Record ]]

[[VPC - 10.20.0.0/16         - 64k hosts]] ------------------------------------------------------------
  I  [Subnet - 10.20.1.0/24 - 256 hosts ] - - - - - -- - - - - - - - - I
   |---->  [EC2(a.b.c.d) (Allow sg_ALB)  - Public IP ] 
   |                 |                  
    [Subnet - 10.20.2.0/24 - 256 hosts ] - - - - - -- - - - - - - - - I
   |---->  [EC2(g.h.i.z) (Allow sg_ALB)  - Public IP ] 
   |
 [ALB X.Y.Z.T (sg_ALB ) ] <------| Listener/Listener_SSL (http/https/www) ( Listener_rule_01 , ... )
                        | ------> [S3-logs ( bucket policy | ACL )]
                        | ------> [S3 - IP - Dominio ]
                        |                  
                        |
                        |
[DOMAIN dname  ]        |
[[Alias_Record  --------             ]]


```
       

<!-- ==--==--==--==--==--==--==--==--==--==--==--==--==--==--==-- -->

## Referencias (Pendiente)

https://stackoverflow.com/questions/11201316/how-to-configure-ssl-for-amazon-s3-bucket --> Informacion Bucket SSL
https://terraformguru.com/terraform-real-world-on-aws-ec2/12-ALB-HTTPHeader-QueryString-Redirects/#step-02-04-rule-4-host-header-redirect --> Terraform Rules examples
https://aws.amazon.com/es/premiumsupport/knowledge-center/cloudfront-invalid-viewer-certificate/ --> Invalid certificate
https://runebook.dev/es/docs/terraform/providers/aws/r/cloudfront_distribution --> Terraform Cloudfront en castellano
https://adamtheautomator.com/terraform-autoscaling-group/ --> Autoscaling ASG Policy
https://www.aloneguid.uk/posts/2022/09/curl-stress-testing/ --> Stress with curl
https://linuxconfig.org/multi-threaded-xargs-with-examples --> Multi Thread Xargs
